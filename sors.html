<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×¦×™×¨×ª ×¤×¨×•×™×§×˜ ×—×“×©</title>
    <link rel="stylesheet" href="style3.css">
</head>

<body>
    <div class="ggg">
        <button onclick="location.href='home.html'" class="add-btn2">ğŸ”™ ×—×–×•×¨</button>
    </div>

    <div class="container">
        <div class="header">
            <button id="addElementBtn" title="×”×•×¡×£ ××œ×× ×˜">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>

        </div>
        <form id="projectForm">
            <!-- ×”××œ×× ×˜×™× ×™×ª×•×¡×¤×• ×›××Ÿ -->
        </form>
    </div>

    <!-- ×ª×¤×¨×™×˜ ×”×•×¡×¤×” -->
    <div id="menu" class="hidden">
        <h3>×”×•×¡×¤×ª ××œ×× ×˜</h3>
        <button id="addCustomElementBtn" type="button">××œ×× ×˜ ×—×“×©</button>
        <hr>
        <div id="presetElements"></div>
    </div>

    <!-- ×¤×•×¤××¤ ×œ××œ×× ×˜ ×—×“×© -->
    <div id="customElementPopup" class="hidden">
        <h3>×¦×•×¨ ××œ×× ×˜ ××•×ª××</h3>
        <form id="customElementForm">
            <label>×›×•×ª×¨×ª:</label>
            <input type="text" id="elementTitle" required>
            <label>×¦×‘×¢ ×›×•×ª×¨×ª:</label>
            <input type="color" id="elementColor" value="#000000">
            <label>×˜×§×¡×˜:</label>
            <textarea id="elementText" required></textarea>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                <button type="submit" class="submitBtn">×”×•×¡×£</button>
                <button type="button" class="submitBtn" id="cancelCustom">×‘×™×˜×•×œ</button>
            </div>
        </form>
    </div>


    <div class="upload-panel">
        <label for="fileUpload" class="upload-label">ğŸ“ ×”×¢×œ××ª ×§×‘×¦×™× / ×ª××•× ×•×ª / ×¡×¨×˜×•× ×™×</label>
        <input type="file" id="fileUpload" multiple accept="video/*,image/*,.pdf,.doc,.docx" hidden />
        <div id="filePreviewContainer" class="file-preview-container"></div>
    </div>
    <div id="projectsContainer"></div>

    <!-- ××•×“×œ ×œ×¦×¤×™×™×” ×‘×ª××•× ×” -->
    <div id="imageModal" class="hidden">
        <span id="closeModal">&times;</span>
        <img id="modalImage" src="" alt="×”×¦×’×”" />
        <button id="prevImage">â—€</button>
        <button id="nextImage">â–¶</button>
    </div>


    <button id="saveBtn" class="submitBtn" type="button">×©××•×¨ ×¤×¨×•×™×§×˜</button>
    <div id="customBanner" class="hidden"></div>



    <div id="popupOverlay" class="hidden"></div>
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabaseUrl = 'https://emaxgeigsgvusswhwjtr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVtYXhnZWlnc2d2dXNzd2h3anRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MjY4MTAsImV4cCI6MjA2NTAwMjgxMH0.YysDKHpjuxq9yZ6S6eIN4wR6r0S2jmkdICARMzx6WRM';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // ×¢×›×©×™×• ×ª×•×›×œ ×œ×”×©×ª××© ×‘-supabase.from(...)

        // ×“×•×’××” ×§×¦×¨×” ×œ×‘×“×™×§×”:
        const { data, error } = await supabase.from('projects').select('*');
        console.log(data, error);

        document.getElementById("customElementForm").addEventListener("submit", (e) => {
            e.preventDefault();
            createCustomElement();
        });

        document.getElementById("cancelCustom").addEventListener("click", () => {
            document.getElementById("customElementPopup").classList.add("hidden");
        });

        const elements = [
            { label: "×©× ×”×¤×¨×•×™×§×˜", type: "text", id: "projectName" },
            { label: "×§×•×“/××¡×¤×¨ ×¤×¨×•×™×§×˜", type: "text", id: "projectCode" },
            { label: "×ª××¨×™×š ×”×ª×—×œ×”", type: "date", id: "startDate" },
            { label: "×ª××¨×™×š ×¡×™×•× ××©×•×¢×¨", type: "date", id: "endDate" },
            { label: "×›×ª×•×‘×ª ×”×¤×¨×•×™×§×˜", type: "text", id: "address" },
            { label: "×¢×™×¨", type: "text", id: "city" },
            { label: "×¡×˜×˜×•×¡ ×¤×¨×•×™×§×˜", type: "select", id: "status", options: ["×‘×ª×›× ×•×Ÿ", "×”×ª×—×™×œ", "×‘×ª×”×œ×™×š", "××•×©×”×”", "×”×•×©×œ×"] },
            { label: "×¡×•×’ ×¤×¨×•×™×§×˜", type: "select", id: "type", options: ["××’×•×¨×™×", "××¡×—×¨×™", "×ª×©×ª×™×•×ª", "×©×™×¤×•×¥", "××—×¨"] },
            { label: "×©×˜×— ×‘× ×™×” (×\"×¨)", type: "number", id: "area" },
            { label: "×’×•×‘×” ×‘× ×™×™×Ÿ (××˜×¨)", type: "number", id: "height" },
            { label: "××¡×¤×¨ ×§×•××•×ª", type: "number", id: "floors" },
            { label: "×ª×§×¦×™×‘ (â‚ª)", type: "number", id: "budget" },
            { label: "×¤×™×¨×•×˜ ×›×œ×œ×™ / ×ª×™××•×¨ ×”×¤×¨×•×™×§×˜", type: "textarea", id: "description" },
        ];

        const form = document.getElementById("projectForm");
        const menu = document.getElementById("menu");
        const popup = document.getElementById("customElementPopup");
        const presetElementsDiv = document.getElementById("presetElements");

        document.getElementById("addElementBtn").onclick = () => {
            menu.classList.toggle("hidden");
        };

        function addElement(el) {
            const label = document.createElement("label");
            label.textContent = el.label;
            label.setAttribute("for", el.id);
            form.appendChild(label);

            const wrapper = document.createElement("div");
            const isDate = el.type === "date";
            wrapper.className = isDate ? "date-wrapper" : "textarea-container";

            let input;
            if (el.type === "textarea") {
                input = document.createElement("textarea");
            } else if (el.type === "select") {
                input = document.createElement("select");
                el.options.forEach(opt => {
                    const option = document.createElement("option");
                    option.value = opt;
                    option.textContent = opt;
                    input.appendChild(option);
                });
            } else {
                input = document.createElement("input");
                input.type = el.type;
            }

            input.id = el.id;
            input.name = el.id;

            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "ğŸ—‘ï¸";
            deleteBtn.type = "button";
            deleteBtn.className = isDate ? "delete-outside" : "delete-inside-textarea";
            deleteBtn.onclick = () => {
                label.remove();
                wrapper.remove();
            };

            wrapper.appendChild(input);
            wrapper.appendChild(deleteBtn);
            form.appendChild(wrapper);
        }
        elements.forEach((el, index) => {
            const wrapper = document.createElement("label");

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = index;
            checkbox.dataset.id = el.id;

            const span = document.createElement("span");
            span.textContent = el.label;

            wrapper.appendChild(checkbox);
            wrapper.appendChild(span);

            presetElementsDiv.appendChild(wrapper);
        });

        // ×”×•×¡×£ ×›×¤×ª×•×¨ ××™×©×•×¨
        const confirmBtn = document.createElement("button");
        confirmBtn.textContent = "××™×©×•×¨";
        confirmBtn.className = "confirm-btn";
        confirmBtn.onclick = () => {
            const selected = presetElementsDiv.querySelectorAll("input[type=checkbox]:checked");
            selected.forEach(cb => {
                const el = elements[parseInt(cb.value)];
                addElement(el);
            });
            menu.classList.add("hidden");
        };
        menu.appendChild(confirmBtn);

        function addCustomElement() {
            popup.classList.remove("hidden");
        }
        async function createCustomElement() {
            const labelText = document.getElementById("elementTitle").value;
            const color = document.getElementById("elementColor").value;
            const text = document.getElementById("elementText").value;
            const projectId = localStorage.getItem("last_project_id"); // ××• ×©×™×˜×” ××—×¨×ª ×œ×©××•×¨ ID
            const label = document.createElement("label");

            console.log("ğŸ§ª project_id ×œ×©××™×¨×”:", projectId);

            label.textContent = labelText;
            label.style.color = color;
            form.appendChild(label);

            const wrapper = document.createElement("div");
            wrapper.className = "textarea-container";

            const input = document.createElement("input");
            input.type = "text";
            input.value = text;
            input.style.color = color;

            const safeId = labelText.replace(/\s+/g, "_");
            input.name = safeId;
            input.id = safeId;

            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "ğŸ—‘ï¸";
            deleteBtn.type = "button";
            deleteBtn.className = "delete-inside-textarea";
            deleteBtn.onclick = () => {
                label.remove();
                wrapper.remove();
            };

            wrapper.appendChild(input);
            wrapper.appendChild(deleteBtn);
            form.appendChild(wrapper);


            if (projectId) {
                const { error } = await supabase.from("custom_elements").insert([{
                    project_id: projectId,
                    title: labelText,
                    text: text,
                    color: color
                }]);

                if (error) {
                    console.error("×©×’×™××” ×‘×©××™×¨×ª ××œ×× ×˜ ××•×ª××:", error.message);
                }
            } else {
                console.warn("×œ× × ××¦× ××–×”×” ×¤×¨×•×™×§×˜ ×œ×©××™×¨×ª ××œ×× ×˜ ××•×ª××.");
            }

            // × ×™×§×•×™ ×©×“×•×ª
            document.getElementById("elementTitle").value = "";
            document.getElementById("elementColor").value = "#000000";
            document.getElementById("elementText").value = "";
            popup.classList.add("hidden");
        }



        document.getElementById("addCustomElementBtn").addEventListener("click", () => {
            popup.classList.remove("hidden");
        });

        document.getElementById("saveBtn").addEventListener("click", async () => {
            const form = document.querySelector("form");
            const data = {};
            const inputs = form.querySelectorAll("input, select, textarea");
            inputs.forEach(input => {
                const key = input.name || input.id;
                const value = input.value;
                if (key && value !== "") {
                    data[key] = value;
                }
            });

            // â¬…ï¸ ×›××Ÿ ××•×¡×™×¤×™× ××ª ×§×˜×¢ ×”×¢×œ××ª ×”××“×™×”
            const mediaUrls = [];

            for (const file of uploadedFiles) {
                const ext = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;
                console.log("ğŸ“¤ ××¢×œ×”:", fileName, file);

                const { data: publicData } = supabase
                    .storage
                    .from('media')
                    .getPublicUrl(fileName);

                if (publicData?.publicUrl) {
                    mediaUrls.push(publicData.publicUrl);
                    console.log("ğŸ”— URL × ×•×¡×£:", publicData.publicUrl);
                } else {
                    console.warn("âš ï¸ ×œ× × ×•×¦×¨ URL ×¦×™×‘×•×¨×™ ×¢×‘×•×¨:", fileName);
                }

                const url = supabase
                    .storage
                    .from('media')
                    .getPublicUrl(fileName).data.publicUrl;


                mediaUrls.push(url);
            }
        }); document.getElementById("saveBtn").addEventListener("click", async () => {
            const form = document.querySelector("form");
            const data = {};
            const inputs = form.querySelectorAll("input, select, textarea");

            inputs.forEach(input => {
                const key = input.name || input.id;
                const value = input.value;
                if (key && value !== "") {
                    data[key] = value;
                }
            });

            // â¬…ï¸ ×©×œ×‘ 1: ×”×¢×œ××ª ×§×‘×¦×™ ××“×™×”
            const mediaUrls = [];

            for (const file of uploadedFiles) {
                const ext = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;

                const { data: uploadData, error: uploadError } = await supabase
                    .storage
                    .from('media') // ×•×“× ×©×™×¦×¨×ª bucket ×‘×©× 'media'
                    .upload(fileName, file);

                if (uploadError) {
                    console.error("×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥:", uploadError.message);
                    continue;
                }

                const { data: publicUrlData } = supabase
                    .storage
                    .from('media')
                    .getPublicUrl(fileName);

                mediaUrls.push(publicUrlData.publicUrl);
            }

            // â¬…ï¸ ×©×œ×‘ 2: ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×•×©××™×¨×” ×œ×˜×‘×œ×”
            const fixedData = {
                projectname: data.projectName,
                projectcode: data.projectCode,
                startdate: data.startDate,
                enddate: data.endDate,
                address: data.address,
                city: data.city,
                status: data.status,
                type: data.type,
                area: data.area,
                height: data.height,
                floors: data.floors,
                budget: data.budget,
                description: data.description,
                media_urls: mediaUrls // ×•×“× ×©×™×© ×¢××•×“×” ×›×–×• ×‘×˜×‘×œ×ª 'projects'
            };

            const { data: saved, error } = await supabase
                .from('projects')
                .insert([fixedData])
                .select()
                .single();

            if (error) {
                console.error("×©×’×™××” ×‘×©××™×¨×ª ×¤×¨×•×™×§×˜:", error.message);
                showCustomBanner("×©×’×™××” ×‘×©××™×¨×”: " + error.message);
            } else {
                localStorage.setItem("last_project_id", saved.id);
                showCustomBanner("×”×¤×¨×•×™×§×˜ × ×©××¨ ×‘×”×¦×œ×—×”!");
                setTimeout(() => {
                    window.location.href = "home.html";
                }, 500);
            }
        });


        function showCustomBanner(message, duration = 3000) {
            const banner = document.getElementById("customBanner");
            banner.textContent = message;
            banner.classList.remove("hidden");
            banner.classList.add("show");

            setTimeout(() => {
                banner.classList.remove("show");
                setTimeout(() => {
                    banner.classList.add("hidden");
                }, 500);
            }, duration);
        }

        const fileInput = document.getElementById("fileUpload");
        const previewContainer = document.getElementById("filePreviewContainer");
        let uploadedFiles = [];

        fileInput.addEventListener("change", (e) => {
            const files = Array.from(e.target.files);

            files.forEach(file => {
                const url = URL.createObjectURL(file);

                const wrapper = document.createElement("div");
                wrapper.className = "preview-wrapper";

                const preview = document.createElement(file.type.startsWith("image/") ? "img" : "video");
                preview.src = url;
                if (file.type.startsWith("video/")) preview.controls = true;

                preview.className = "preview-item";

                if (file.type.startsWith("image/")) {
                    previewImages.push(preview);
                    const index = previewImages.length - 1;
                    preview.onclick = () => openImageViewer(index);
                }


                // ×›×¤×ª×•×¨ ××—×™×§×”
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-preview-outside";

                const icon = document.createElement("img");
                icon.src = "images/delete-icon.png";
                icon.alt = "××—×§";
                icon.style.width = "22px";
                icon.style.height = "22px";
                deleteBtn.appendChild(icon);

                deleteBtn.onclick = () => {
                    wrapper.remove();
                    uploadedFiles = uploadedFiles.filter(f => f !== file);

                    // ××¡×™×¨ ××”××¢×¨×š ×’× ××ª ×”×ª××•× ×” ×œ×¤×•×¤××¤ (×× ×§×™×™××ª)
                    if (file.type.startsWith("image/")) {
                        const indexToRemove = previewImages.findIndex(p => p.src === url);
                        if (indexToRemove !== -1) previewImages.splice(indexToRemove, 1);
                    }
                };

                wrapper.appendChild(deleteBtn);
                wrapper.appendChild(preview);
                previewContainer.appendChild(wrapper);
                uploadedFiles.push(file);
            });


            fileInput.value = '';
        });

        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        const closeModal = document.getElementById("closeModal");
        const prevBtn = document.getElementById("prevImage");
        const nextBtn = document.getElementById("nextImage");

        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartTime = 0;

        modal.addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartTime = new Date().getTime();
        });

        modal.addEventListener("touchend", (e) => {
            touchEndX = e.changedTouches[0].screenX;
            const duration = new Date().getTime() - touchStartTime;
            handleSwipe(duration);
        });

        function handleSwipe(duration) {
            const distance = touchStartX - touchEndX;
            const fast = duration < 500; // ×–××Ÿ ×§×¦×¨ ×œ×”×—×œ×§×”
            const far = Math.abs(distance) > 100; // ××¨×—×§ ××™× ×™××œ×™ ×©×œ 100 ×¤×™×§×¡×œ×™× ×œ×”×—×œ×§×”

            // ×”×¤×¢×œ ×”×—×œ×§×” ×¨×§ ×× ×”××¨×—×§ ××¡×¤×™×§ ×’×“×•×œ ×•×”××’×¢ ×”×™×” ××”×™×¨
            if (!far || !fast) return;

            if (distance > 0) {
                updateViewer(1); // ×”×—×œ×§×” ×©×××œ×”
            } else {
                updateViewer(-1); // ×”×—×œ×§×” ×™××™× ×”
            }
        }

        let previewImages = [];
        let currentIndex = 0;

        function openImageViewer(index) {
            currentIndex = index;
            modalImg.src = previewImages[index].src;
            modal.classList.remove("hidden");
            // ××¤×¡ ××ª ××©×ª× ×™ ×”××’×¢ ×›×“×™ ×œ×× ×•×¢ ×“×¤×“×•×£ ×œ× ×¨×¦×•×™
            touchStartX = 0;
            touchEndX = 0;
        }

        closeModal.onclick = () => modal.classList.add("hidden");
        prevBtn.onclick = () => updateViewer(-1);
        nextBtn.onclick = () => updateViewer(1);

        function updateViewer(direction) {
            const outClass = direction > 0 ? 'slide-out-left' : 'slide-out-right';
            const inClass = direction > 0 ? 'slide-in-right' : 'slide-in-left';

            modalImg.classList.add(outClass);

            modalImg.addEventListener('animationend', function handler() {
                modalImg.removeEventListener('animationend', handler);

                // ×¢×“×›×•×Ÿ ××™× ×“×§×¡ ×•×ª××•× ×”
                currentIndex += direction;
                if (currentIndex < 0) currentIndex = previewImages.length - 1;
                if (currentIndex >= previewImages.length) currentIndex = 0;
                modalImg.src = previewImages[currentIndex].src;

                // ×”×›× ×¡×” ×¢× ×× ×™××¦×™×”
                modalImg.classList.remove(outClass);
                modalImg.classList.add(inClass);

                modalImg.addEventListener('animationend', function cleanup() {
                    modalImg.removeEventListener('animationend', cleanup);
                    modalImg.classList.remove(inClass);
                });
            });
        }

    </script>
</body>

</html>
